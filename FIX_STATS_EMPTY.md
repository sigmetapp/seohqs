# Исправление проблемы с пустой статистикой embed скриптов

## Проблема
Статистика на странице `/stats` пустая, хотя скрипты должны логировать вызовы.

## Возможные причины

1. **RLS политики блокируют чтение данных**
   - Решение: Выполните SQL скрипт `scripts/fix_embed_stats_rls.sql` в Supabase Dashboard → SQL Editor

2. **Данные не записываются в базу**
   - Проверьте логи API роута `/api/embed/log` в Vercel Dashboard
   - Убедитесь, что скрипты вызывают `/api/embed/log` с правильными параметрами

3. **Проблема с часовыми поясами или форматом даты**
   - Проверьте логи API роута `/api/stats/embed` - там есть информация о запросах

4. **Service Role Key не установлен**
   - Убедитесь, что переменная окружения `SUPABASE_SERVICE_ROLE_KEY` установлена в Vercel
   - Service Role Key обходит RLS политики

## Шаги диагностики

1. **Проверьте логи Vercel:**
   - Зайдите в Vercel Dashboard → ваш проект → Logs
   - Найдите логи для `/api/stats/embed` и `/api/embed/log`
   - Проверьте, есть ли ошибки

2. **Проверьте данные в базе:**
   ```sql
   SELECT COUNT(*) FROM embed_script_logs;
   SELECT * FROM embed_script_logs ORDER BY created_at DESC LIMIT 10;
   ```

3. **Проверьте RLS политики:**
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'embed_script_logs';
   ```

4. **Выполните исправление RLS:**
   - Запустите `scripts/fix_embed_stats_rls.sql` в Supabase SQL Editor

5. **Проверьте переменные окружения:**
   - `SUPABASE_SERVICE_ROLE_KEY` - должен быть установлен
   - `NEXT_PUBLIC_SUPABASE_URL` - должен быть установлен
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY` - должен быть установлен

## Что было исправлено

1. ✅ Добавлено подробное логирование в API роуты
2. ✅ Добавлена проверка всех данных в таблице (не только за период)
3. ✅ Добавлена проверка используемого ключа (service role или anon)
4. ✅ Создан SQL скрипт для исправления RLS политик
5. ✅ Улучшена обработка ошибок

## Проверка работы

После исправления:
1. Откройте страницу `/stats`
2. Проверьте логи в Vercel Dashboard
3. Убедитесь, что данные отображаются

Если проблема сохраняется, проверьте логи и сообщите о найденных ошибках.
