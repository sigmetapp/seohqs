# Логика работы Content Generator (`/content-generator`)

## Общая схема работы

Страница `/content-generator` генерирует SEO-статьи в несколько этапов:
1. **Outline** - создание структуры статьи
2. **Sections** - последовательная генерация секций
3. **SEO Packaging** - создание метаданных
4. **Результат** - отображение готовой статьи

---

## 1. ИНИЦИАЛИЗАЦИЯ И АВТОРИЗАЦИЯ

### Проверка авторизации
- При загрузке страницы вызывается `checkAuth()` → `/api/auth/user/me`
- Если пользователь не авторизован (401) → редирект на `/login`
- Если авторизован → загружается форма генерации

**Что проверить:**
- ✅ Редирект на `/login` для неавторизованных пользователей
- ✅ Отображение формы для авторизованных пользователей

---

## 2. ФОРМА ПАРАМЕТРОВ ГЕНЕРАЦИИ

### Поля формы:
- **Topic** (обязательное) - тема статьи
- **Language** - язык (по умолчанию: RU)
- **Desired length** - желаемая длина в словах (по умолчанию: 2000)
- **Audience** - целевая аудитория (general, beginner, intermediate, advanced, professionals, marketers, developers, business owners, students, entrepreneurs)
- **Author Persona** - авторская персона (expert, beginner, practitioner, researcher, industry insider, thought leader, educator, consultant)
- **Angle** - угол подачи (informative, practical, analytical, educational, comparative, case study, how-to, opinion, review, news)
- **Content Goal** - цель контента (SEO article, Landing page, Blog post, Review, Guide, FAQ page)
- **Complexity** - уровень сложности:
  - `low` - быстрые короткие статьи
  - `medium` - качественный блоговый контент (по умолчанию)
  - `high` - экспертные лонгриды уровня редакторов
- **Additional Constraints** - дополнительные ограничения (опционально)

### Валидация:
- Topic обязателен (проверка на клиенте перед отправкой)

**Что проверить:**
- ✅ Все поля формы отображаются корректно
- ✅ Валидация Topic работает (нельзя отправить пустую форму)
- ✅ Значения по умолчанию установлены правильно

---

## 3. ЭТАП 1: GENERATING OUTLINE (Шаг 1/3)

### Процесс:
1. **Клиент** → POST `/api/content/outline` с параметрами формы
2. **Таймаут на клиенте:** 35 секунд (запас для серверных 30 секунд)
3. **Сервер:**
   - Проверка авторизации
   - Получение OpenAI API Key из настроек (`openai_api_key`)
   - Получение Outline Assistant ID из настроек (`openai_outline_assistant_id`)
   - Проверка существования ассистента
   - Определение целевого количества секций на основе `desiredLength`:
     - ≤700 слов → 3-4 секции
     - 701-1500 слов → 4-6 секций
     - >1500 слов → 6-10 секций
   - Определение параметров структуры на основе `complexity`:
     - `low` - простая структура, минимум секций, поверхностная глубина
     - `medium` - сбалансированная структура, умеренная глубина
     - `high` - глубокая структура, много секций, глубокие инсайты
   - Создание промпта с параметрами
   - Вызов OpenAI Assistants API (таймаут 30 секунд)
   - Парсинг JSON ответа
   - **Валидация количества секций:**
     - Если количество секций не соответствует желаемой длине → попытка пересборки outline
     - Если пересборка не помогла → обрезка секций (оставляются первые N)
   - Возврат массива секций: `{ id, title, description }`

4. **Клиент:**
   - Отображение структуры статьи (список секций)
   - Вычисление целевой длины секции: `targetSectionWords = desiredLength / sectionsCount`
   - Сохранение `targetSectionWords` для использования при генерации секций

### UI отображение:
- Прогресс: "Generating outline… (Шаг 1/3)"
- После успеха: зеленая карточка со списком секций

**Что проверить:**
- ✅ Outline генерируется корректно
- ✅ Количество секций соответствует желаемой длине статьи
- ✅ Структура отображается в UI
- ✅ Таймаут работает (35 секунд на клиенте)
- ✅ Ошибки обрабатываются и показываются пользователю
- ✅ Проверка настроек: `openai_api_key` и `openai_outline_assistant_id` должны быть настроены

---

## 4. ЭТАП 2: GENERATING SECTIONS (Шаг 2/3)

### Процесс:
1. **Последовательная генерация** каждой секции из outline
2. Для каждой секции:
   - **Клиент** → POST `/api/content/section` с:
     - `sectionTitle`
     - `sectionDescription`
     - `targetSectionWords` (вычислено на этапе outline)
     - `complexityLevel` (из формы)
     - `authorPersona`, `angle`, `contentGoal`
   - **Таймаут на клиенте:** 60 секунд (запас для серверных 55 секунд)
   - **Сервер:**
     - Проверка авторизации
     - Получение OpenAI API Key и Section Assistant ID (`openai_section_assistant_id`)
     - Определение параметров стиля на основе `complexityLevel`:
       - `low` - кратко, поверхностно, 400-800 слов
       - `medium` - сбалансированно, 800-1500 слов
     - Если указан `targetSectionWords` → диапазон ±20% от целевого значения
     - Создание промпта
     - Вызов OpenAI Assistants API (таймаут 55 секунд)
     - **Retry логика при таймауте:**
       - Если таймаут в режиме `medium`/`high` → автоматический retry с `low`
       - Максимум 1 retry
     - Парсинг HTML ответа (удаление markdown блоков, JSON оберток)
     - Возврат: `{ success: true, sectionHtml, complexityLevel }`

3. **Клиент:**
   - Отображение прогресса: "Генерация секции X из Y: [название]..."
   - Обновление статусов секций в реальном времени
   - Отслеживание:
     - Успешных секций (`success` или `success_light`)
     - Секций с низкой сложностью (`success_light` - упрощенный режим)
     - Неудачных секций (таймаут, ошибки OpenAI, ошибки backend)
   - Технические логи для каждой секции

### Статусы секций:
- `success` - успешно сгенерирована (medium/high)
- `success_light` - успешно сгенерирована в упрощенном режиме (low)
- `timeout` - превышен лимит времени
- `backend_error` - ошибка backend или пустой HTML
- `openai_error` - ошибка OpenAI API
- `skipped` - пропущена

### UI отображение:
- Карточки статусов секций (`SectionStatusCard`) с:
  - Индикатором статуса (цветная точка)
  - Названием секции
  - Временем генерации
  - Количеством слов
  - Уровнем сложности
  - Кнопками перегенерации (Medium/Low/High)
  - Кнопками показа/скопирования HTML
  - Техническими логами (если есть)

**Что проверить:**
- ✅ Секции генерируются последовательно (не параллельно)
- ✅ Прогресс отображается корректно (X из Y)
- ✅ Статусы секций обновляются в реальном времени
- ✅ Таймауты работают (60 секунд на клиенте)
- ✅ Retry логика работает (при таймауте medium → retry с low)
- ✅ Секции с `success_light` помечаются визуально
- ✅ Неудачные секции сохраняются в `failedSections`
- ✅ Технические логи записываются и отображаются
- ✅ Проверка настроек: `openai_section_assistant_id` должен быть настроен

---

## 5. ЭТАП 3: ASSEMBLING (Склейка секций)

### Процесс:
1. **На клиенте** собирается финальный HTML:
   - Берется HTML всех успешно сгенерированных секций
   - Для секций с `success_light` добавляется предупреждающий баннер:
     ```html
     <div style="...">⚠️ Упрощённый режим: Эта секция была сгенерирована в упрощённом режиме из-за таймаута...</div>
     ```
   - Секции склеиваются через `\n`
   - Неудачные секции пропускаются

**Что проверить:**
- ✅ Только успешные секции попадают в финальный HTML
- ✅ Баннеры для упрощенных секций добавляются корректно
- ✅ Порядок секций сохраняется

---

## 6. ЭТАП 4: SEO PACKAGING (Шаг 3/3)

### Процесс:
1. **Клиент** → POST `/api/content/seo` с:
   - `fullArticleHtml` (собранный HTML)
   - `topic`, `language`, `authorPersona`, `angle`
2. **Таймаут на клиенте:** 35 секунд (запас для серверных 30 секунд)
3. **Сервер:**
   - Проверка авторизации
   - Получение OpenAI API Key и SEO Assistant ID (`openai_seo_assistant_id`)
   - Создание промпта с полным HTML статьи
   - Вызов OpenAI Assistants API (таймаут 30 секунд)
   - Парсинг JSON ответа
   - Возврат: `{ meta_title, meta_description, h1, faq, semantic_topics }`

4. **Клиент:**
   - Если SEO успешно → сохраняются метаданные
   - Если таймаут/ошибка → продолжаем без SEO (не критично)
   - Показывается предупреждение, если SEO не сгенерирован

### UI отображение:
- Прогресс: "Creating SEO metadata… (Шаг 3/3)"
- После успеха: поля Meta Title, Meta Description, H1, FAQ, Semantic Topics

**Что проверить:**
- ✅ SEO метаданные генерируются корректно
- ✅ Таймаут работает (35 секунд на клиенте)
- ✅ При ошибке SEO процесс продолжается (не блокирует генерацию статьи)
- ✅ Предупреждения показываются, если SEO не сгенерирован
- ✅ Проверка настроек: `openai_seo_assistant_id` должен быть настроен

---

## 7. ЭТАП 5: РЕЗУЛЬТАТ

### Отображение:
1. **SEO данные:**
   - H1 (если есть)
   - Meta Title (с предупреждением, если пусто)
   - Meta Description (с предупреждением, если пусто)
   - FAQ (массив вопросов/ответов)
   - Semantic Topics (массив тем)
   - Summary (статистика генерации)

2. **HTML контент:**
   - Отображение с стилизацией (prose)
   - Кнопки копирования: "Copy HTML" и "Copy Plain Text"

3. **Предупреждения:**
   - Список неудачных секций (если есть)
   - Информация об упрощенных секциях

### Кнопки копирования:
- Copy H1
- Copy Meta Title
- Copy Meta Description
- Copy HTML
- Copy Plain Text

**Что проверить:**
- ✅ Все SEO поля отображаются корректно
- ✅ HTML контент отображается с правильной стилизацией
- ✅ Кнопки копирования работают
- ✅ Предупреждения показываются для пустых SEO полей
- ✅ Список неудачных секций отображается (если есть)

---

## 8. ПЕРЕГЕНЕРАЦИЯ СЕКЦИЙ

### Процесс:
1. Пользователь нажимает "Перегенерировать (Medium/Low/High)" на карточке секции
2. **Клиент** → POST `/api/content/section` с:
   - Те же параметры, что и при первоначальной генерации
   - Выбранный уровень сложности
3. **Сервер:** аналогично обычной генерации секции
4. **Клиент:**
   - Обновление статуса секции
   - Пересборка финального HTML (если секция успешно перегенерирована)
   - Обновление счетчика повторов (`retryCount`)

**Что проверить:**
- ✅ Перегенерация работает для всех уровней сложности
- ✅ Статус секции обновляется после перегенерации
- ✅ Финальный HTML пересобирается после успешной перегенерации
- ✅ Счетчик повторов увеличивается
- ✅ Кнопки перегенерации блокируются во время процесса

---

## 9. ТАЙМЕР И ПРОГРЕСС

### Таймер:
- Запускается при начале генерации (`startTime`)
- Обновляется каждую секунду
- Отображается в формате: "Xм Yс" или "Ys"
- Останавливается при завершении или ошибке

### Прогресс:
- "Generating outline… (Шаг 1/3)"
- "Генерация секции X из Y: [название]... (Шаг 2/3: X/Y)"
- "Creating SEO metadata… (Шаг 3/3)"
- "Статья готова! ✓" или "Статья готова! (X секций пропущено)"

**Что проверить:**
- ✅ Таймер работает корректно
- ✅ Прогресс отображается правильно на каждом этапе
- ✅ Таймер останавливается при завершении/ошибке

---

## 10. ОБРАБОТКА ОШИБОК

### Типы ошибок:
1. **Ошибки авторизации** → редирект на `/login`
2. **Ошибки валидации** → показ сообщения об ошибке
3. **Таймауты** → показ понятного сообщения с рекомендацией
4. **Ошибки OpenAI** → показ сообщения с типом ошибки
5. **Ошибки backend** → показ сообщения об ошибке

### Поведение при ошибках:
- **Outline ошибка** → весь процесс останавливается
- **Секция ошибка** → секция пропускается, процесс продолжается
- **SEO ошибка** → процесс продолжается без SEO метаданных

**Что проверить:**
- ✅ Все типы ошибок обрабатываются корректно
- ✅ Сообщения об ошибках понятны пользователю
- ✅ Процесс продолжается при некритичных ошибках (секции, SEO)
- ✅ Ошибки логируются в консоль

---

## 11. НАСТРОЙКИ (Требуются в БД)

### Обязательные настройки:
1. `openai_api_key` - API ключ OpenAI (или `OPENAI_API_KEY` в env)
2. `openai_outline_assistant_id` - ID ассистента для генерации структуры
3. `openai_section_assistant_id` - ID ассистента для генерации секций
4. `openai_seo_assistant_id` - ID ассистента для генерации SEO метаданных

**Что проверить:**
- ✅ Все настройки присутствуют в БД
- ✅ Ассистенты существуют в OpenAI и доступны по ID
- ✅ API ключ валиден и имеет доступ к Assistants API

---

## 12. ЧЕКЛИСТ ДЛЯ ПРОВЕРКИ

### Авторизация:
- [ ] Редирект неавторизованных пользователей на `/login`
- [ ] Форма отображается для авторизованных пользователей

### Форма:
- [ ] Все поля отображаются корректно
- [ ] Валидация Topic работает
- [ ] Значения по умолчанию установлены

### Outline (Шаг 1):
- [ ] Генерация структуры работает
- [ ] Количество секций соответствует желаемой длине
- [ ] Структура отображается в UI
- [ ] Таймаут работает (35 секунд)
- [ ] Ошибки обрабатываются корректно
- [ ] Настройки `openai_outline_assistant_id` проверены

### Sections (Шаг 2):
- [ ] Секции генерируются последовательно
- [ ] Прогресс отображается (X из Y)
- [ ] Статусы обновляются в реальном времени
- [ ] Таймауты работают (60 секунд)
- [ ] Retry логика работает (medium → low)
- [ ] Секции с `success_light` помечаются
- [ ] Неудачные секции сохраняются
- [ ] Технические логи записываются
- [ ] Настройки `openai_section_assistant_id` проверены

### Assembling:
- [ ] Только успешные секции попадают в HTML
- [ ] Баннеры для упрощенных секций добавляются
- [ ] Порядок секций сохраняется

### SEO (Шаг 3):
- [ ] SEO метаданные генерируются
- [ ] Таймаут работает (35 секунд)
- [ ] При ошибке SEO процесс продолжается
- [ ] Предупреждения показываются для пустых SEO полей
- [ ] Настройки `openai_seo_assistant_id` проверены

### Результат:
- [ ] Все SEO поля отображаются
- [ ] HTML контент отображается с стилизацией
- [ ] Кнопки копирования работают
- [ ] Предупреждения показываются корректно
- [ ] Список неудачных секций отображается

### Перегенерация:
- [ ] Перегенерация работает для всех уровней
- [ ] Статус секции обновляется
- [ ] Финальный HTML пересобирается
- [ ] Счетчик повторов увеличивается

### Таймер и прогресс:
- [ ] Таймер работает корректно
- [ ] Прогресс отображается на каждом этапе
- [ ] Таймер останавливается при завершении

### Обработка ошибок:
- [ ] Все типы ошибок обрабатываются
- [ ] Сообщения понятны пользователю
- [ ] Процесс продолжается при некритичных ошибках
- [ ] Ошибки логируются

### Настройки:
- [ ] Все настройки присутствуют в БД
- [ ] Ассистенты существуют и доступны
- [ ] API ключ валиден

---

## 13. ТЕХНИЧЕСКИЕ ДЕТАЛИ

### API Endpoints:
- `POST /api/content/outline` - генерация структуры
- `POST /api/content/section` - генерация секции
- `POST /api/content/seo` - генерация SEO метаданных

### Используемые технологии:
- OpenAI Assistants API (для всех этапов)
- Next.js App Router
- React Hooks (useState, useEffect)
- TypeScript

### Таймауты:
- Outline: 30 секунд (сервер), 35 секунд (клиент)
- Section: 55 секунд (сервер), 60 секунд (клиент)
- SEO: 30 секунд (сервер), 35 секунд (клиент)

### Retry логика:
- Только для секций
- При таймауте в режиме medium/high → автоматический retry с low
- Максимум 1 retry

---

## 14. ПОТЕНЦИАЛЬНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### Проблема: Outline генерирует неправильное количество секций
**Решение:** Валидация и пересборка outline, обрезка секций при необходимости

### Проблема: Секция не генерируется в срок
**Решение:** Автоматический retry с упрощенным режимом (low)

### Проблема: SEO не генерируется
**Решение:** Процесс продолжается без SEO, показывается предупреждение

### Проблема: Несколько секций не генерируются
**Решение:** Процесс продолжается, неудачные секции сохраняются для перегенерации

---

## ЗАКЛЮЧЕНИЕ

Система генерации контента работает в 3 основных этапах с обработкой ошибок и возможностью перегенерации отдельных секций. Все этапы независимы друг от друга (кроме зависимости секций от outline), что позволяет продолжать процесс даже при частичных ошибках.
