import { NextResponse } from 'next/server';
import { getCurrentUser } from '@/lib/auth-utils';
import { getOpenAIClient } from '@/lib/article-assistants';

export const dynamic = 'force-dynamic';
export const runtime = 'nodejs';

const STRATEGY_PROMPTS: Record<string, string> = {
  mode1: `[РЕЖИМ 1: мягкий перефраз]
Цель: сделать текст более человеческим и плавным, не меняя структуру и логику.
Правила:
- Сохрани структуру абзацев.
- Сохрани смысл каждого предложения.
- Перепиши текст более простым и живым языком.
- Не добавляй новых идей и примеров.
- Не меняй порядок абзацев.`,

  mode2: `[РЕЖИМ 2: чистка штампов]
Цель: убрать "запах ИИ" и канцелярит.
Правила:
- Найди и переформулируй все штампованные или слишком общие фразы.
- Убери обороты вроде:
  "в современном мире",
  "на сегодняшний день",
  "не секрет, что",
  "подводя итог",
  "в заключение стоит отметить" и подобные.
- Сохрани смысл, но сделай формулировки более конкретными и естественными.
- Не добавляй новые примеры и истории, работай только с тем, что уже есть.`,

  mode3: `[РЕЖИМ 3: конкретизация]
Цель: сделать мысли более ясными и конкретными без придуманных фактов.
Правила:
- Найди слишком размытые формулировки и сделай их более понятными.
- Можно:
  - заменять общие слова на более точные, если это очевидно из контекста,
  - разбивать слишком длинные предложения на два,
  - объединять слишком мелко нарезанные предложения, если так читается легче.
- Нельзя придумывать новые истории, кейсы, цифры, факты.
- Общий объем текста должен остаться примерно таким же.`,

  mode4: `[РЕЖИМ 4: диалоговый ритм]
Цель: сделать текст более живым за счет ритма и легкого диалога.
Правила:
- Сохрани структуру и смысл текста.
- Сделай ритм более живым:
  - разбивай чрезмерно длинные предложения,
  - объединяй слишком рубленые, если это улучшает читабельность.
- Можно аккуратно добавить нейтральные риторические вопросы или мягкие обращения к читателю, но только если это логично по контексту.
- Не добавляй новые смысловые блоки и примеры.`,

  mode5: `[РЕЖИМ 5: финальная хуманизация]
Цель: финальная вычитка против "роботности".
Правила:
- Пройди по тексту как финальный редактор.
- Найди:
  - повторяющиеся конструкции в начале предложений и абзацев,
  - несколько однотипных по структуре предложений подряд,
  - слишком формальные и "канцелярские" фрагменты.
- Перепиши их более естественно.
- Смысл и структура разделов должны сохраниться.
- Не добавляй новые примеры и факты, только меняй формулировку.`,
};

const SYSTEM_PROMPT = `Ты редактор человеческих текстов.

Твоя роль:
- Ты НИКОГДА не пишешь текст с нуля.
- Ты ВСЕГДА редактируешь только тот текст, который дал пользователь.
- Ты не добавляешь новые смысловые блоки, которых явно нет в исходнике.
- Ты можешь:
  - упрощать формулировки,
  - перефразировать,
  - менять структуру предложений,
  - убирать штампы и канцелярит,
  - делать стиль более живым и человеческим,
  - немного менять порядок фраз, если смысл сохраняется.

Жесткие правила:
- Не придумывай новые факты, данные, кейсы, цифры, истории.
- Если пользователь дал только тему, а текста нет, попроси у него исходный текст для редактуры.
- Сохраняй общий объем текста плюс минус 20 процентов, не раздувай его.
- Не используй длинные тире, только обычный дефис "-".
- Язык ответа должен совпадать с языком исходного текста, если пользователь явно не просит перевод.
- Избегай штампов вроде: "в современном мире", "на сегодняшний день", "не секрет, что", "подводя итог", "в заключение стоит отметить" и любых подобных.

Пользователь может задавать режим работы в квадратных скобках: [РЕЖИМ 1], [РЕЖИМ 2] и т.д.
После режима пользователь дает текст в блоке между <<< и >>>.
Ты строго следуешь описанию выбранного режима.

Если пользователь не указал режим явно, веди себя как [РЕЖИМ 1] с элементами [РЕЖИМ 2] и обязательно НЕ пиши текст с нуля, а редактируй только то, что он прислал.`;

export async function POST(request: Request) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { success: false, error: 'Пользователь не авторизован' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { text, strategy } = body;

    if (!text || !text.trim()) {
      return NextResponse.json(
        { success: false, error: 'Текст обязателен' },
        { status: 400 }
      );
    }

    const selectedStrategy = strategy || 'mode1';
    const strategyPrompt = STRATEGY_PROMPTS[selectedStrategy] || STRATEGY_PROMPTS.mode1;

    // Получаем OpenAI клиент
    const openai = await getOpenAIClient();

    // Формируем промпт для пользователя
    const userPrompt = `${strategyPrompt}

Текст:
<<<
${text}
>>>`;

    // Вызываем OpenAI API
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: SYSTEM_PROMPT,
        },
        {
          role: 'user',
          content: userPrompt,
        },
      ],
      temperature: 0.7,
      max_tokens: 4000,
    });

    const result = completion.choices[0]?.message?.content;

    if (!result) {
      return NextResponse.json(
        { success: false, error: 'Не удалось получить результат от OpenAI' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      success: true,
      result: result.trim(),
    });
  } catch (error: any) {
    console.error('[HUMANIZE] Ошибка:', error);
    return NextResponse.json(
      {
        success: false,
        error: error.message || 'Ошибка обработки текста',
      },
      { status: 500 }
    );
  }
}
