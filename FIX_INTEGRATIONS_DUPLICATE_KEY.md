# Исправление ошибки duplicate key в таблице integrations

## Проблема

При интеграции Google Search Console возникала ошибка:
```
Supabase insert error: duplicate key value violates unique constraint "integrations_pkey"
```

## Причина

Таблица `integrations` была создана с первичным ключом `id BIGINT PRIMARY KEY DEFAULT 1`. Когда код пытался создать запись для нового пользователя без указания `id`, он автоматически получал значение `1`, что вызывало конфликт, если запись с `id=1` уже существовала.

## Решение

### 1. Миграция базы данных

Создана миграция `migrations/017_fix_integrations_primary_key_supabase.sql`, которая:
- Изменяет колонку `id` с `DEFAULT 1` на автоинкремент (`BIGSERIAL`)
- Добавляет уникальный индекс на `user_id`, чтобы каждый пользователь мог иметь только одну запись интеграций
- Удаляет старые записи без `user_id`

**Важно:** Выполните эту миграцию в Supabase SQL Editor перед использованием исправленного кода.

### 2. Обновление кода

Обновлены функции в `lib/db-supabase.ts`:
- `updateIntegrations()` - теперь использует `upsert` вместо `insert` + `update`
- `getIntegrations()` - использует `upsert` при создании новой записи

Это предотвращает ошибки duplicate key, так как `upsert` автоматически обновляет существующую запись или создает новую.

### 3. Обработка ошибок

Добавлена дополнительная обработка ошибок:
- Если возникает ошибка duplicate key (до выполнения миграции), код пытается обновить существующую запись
- Выводится понятное сообщение об ошибке с указанием необходимой миграции

## Инструкция по применению

1. **Выполните миграцию в Supabase:**
   - Откройте Supabase Dashboard
   - Перейдите в SQL Editor
   - Выполните SQL из файла `migrations/017_fix_integrations_primary_key_supabase.sql`

2. **Перезапустите приложение** (если необходимо)

3. **Проверьте интеграцию Google Search Console** - ошибка duplicate key больше не должна возникать

## Технические детали

- Миграция безопасна для существующих данных
- Уникальный индекс на `user_id` гарантирует, что каждый пользователь имеет только одну запись интеграций
- Автоинкремент `id` позволяет создавать записи для разных пользователей без конфликтов
- Код обратно совместим и будет работать даже если миграция еще не выполнена (с fallback на update)
