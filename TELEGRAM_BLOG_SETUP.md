# Настройка автоматической публикации постов из Telegram канала

Эта инструкция поможет вам настроить автоматическую публикацию постов из вашего Telegram канала на сайт в рубрике Blog.

## Требования

1. Telegram канал (например, https://t.me/seohqs/)
2. Telegram бот с правами администратора в канале
3. Доступ к переменным окружения проекта

## Шаги настройки

### 1. Создание Telegram бота

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните токен бота (выглядит как `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2. Добавление бота в канал как администратора

1. Откройте ваш Telegram канал
2. Перейдите в настройки канала (Settings)
3. Выберите "Administrators"
4. Нажмите "Add Administrator"
5. Найдите вашего бота по username
6. Добавьте бота с правами на чтение сообщений

**Важно:** Для работы с каналами через Bot API, бот должен получать обновления. Есть два способа:

**Вариант A: Long Polling (для разработки)**
- Бот автоматически получает обновления при вызове `getUpdates`
- Работает только если бот подписан на канал и получает обновления

**Вариант B: Webhook (для продакшена)**
- Настройте webhook для бота через BotFather: `/setwebhook`
- Укажите URL вашего API endpoint для получения обновлений

**Альтернатива для публичных каналов:**
Если у вас публичный канал, можно использовать парсинг HTML страницы канала вместо Bot API (требует доработки кода).

### 3. Настройка переменных окружения

Добавьте следующие переменные в ваш `.env.local` файл:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHANNEL_USERNAME=seohqs
```

Где:
- `TELEGRAM_BOT_TOKEN` - токен бота, полученный от BotFather
- `TELEGRAM_CHANNEL_USERNAME` - username канала без @ (например, `seohqs` для канала @seohqs)

### 4. Применение миграции базы данных

Выполните миграцию для создания таблицы `blog_posts`:

```sql
-- Файл: migrations/024_blog_posts_table_supabase.sql
-- Примените эту миграцию к вашей базе данных Supabase
```

Или выполните SQL запросы из файла миграции вручную через Supabase Dashboard.

### 5. Первая синхронизация

После настройки выполните первую синхронизацию постов:

**Для загрузки всех исторических постов с оригинальными датами:**
```bash
# Полная синхронизация всех постов из канала
curl "http://localhost:3000/api/blog/sync?full=true"

# Или через браузер откройте:
# http://localhost:3000/api/blog/sync?full=true
```

**Для синхронизации только новых постов (после первой загрузки):**
```bash
# Синхронизация только новых постов
curl -X POST http://localhost:3000/api/blog/sync

# Или через браузер откройте:
# http://localhost:3000/api/blog/sync (метод POST)
```

**Важно:** 
- Полная синхронизация (`?full=true`) загружает все посты из канала через парсинг веб-страницы Telegram и сохраняет оригинальные даты публикации
- Обычная синхронизация (POST) использует Bot API и получает только новые посты, которые появились после добавления бота в канал

### 6. Автоматическая синхронизация

Для автоматической синхронизации постов вы можете настроить cron job или использовать сервис типа Vercel Cron, который будет вызывать `/api/blog/sync` периодически (например, каждый час).

#### Пример настройки Vercel Cron:

Создайте файл `vercel.json` в корне проекта:

```json
{
  "crons": [
    {
      "path": "/api/blog/sync",
      "schedule": "0 * * * *"
    }
  ]
}
```

Это будет синхронизировать посты каждый час.

## Использование

### Просмотр постов

После синхронизации посты будут доступны на странице `/blog`.

### API Endpoints

- `GET /api/blog/posts` - получить список постов (с пагинацией)
- `GET /api/blog/posts/[slug]` - получить конкретный пост
- `POST /api/blog/sync` - синхронизировать новые посты из Telegram (только новые посты после последней синхронизации)
- `GET /api/blog/sync` - получить статус синхронизации
- `GET /api/blog/sync?full=true` - **полная синхронизация всех постов из канала с оригинальными датами**

### Параметры запроса для списка постов

```
GET /api/blog/posts?page=1&limit=10
```

- `page` - номер страницы (по умолчанию: 1)
- `limit` - количество постов на странице (по умолчанию: 10)

## Структура данных

Каждый пост содержит:

- `id` - уникальный ID поста
- `telegram_message_id` - ID сообщения в Telegram
- `telegram_channel_username` - username канала
- `title` - заголовок поста (извлекается из первой строки)
- `content` - текст поста
- `html_content` - HTML версия поста
- `images` - массив изображений с URL и подписями
- `published_at` - дата публикации в Telegram
- `slug` - URL-friendly идентификатор поста
- `created_at` - дата создания записи в БД
- `updated_at` - дата последнего обновления

## Устранение неполадок

### Ошибка "TELEGRAM_BOT_TOKEN не настроен"

Убедитесь, что переменная окружения `TELEGRAM_BOT_TOKEN` установлена в `.env.local` и перезапустите сервер разработки.

### Бот не получает обновления из канала

1. Убедитесь, что бот добавлен как администратор канала
2. Убедитесь, что бот имеет права на чтение сообщений
3. Проверьте, что канал публичный или бот имеет доступ к приватному каналу

### Посты не синхронизируются

1. Проверьте логи сервера на наличие ошибок
2. Убедитесь, что миграция базы данных применена
3. Проверьте, что бот имеет доступ к каналу
4. Попробуйте выполнить синхронизацию вручную через POST запрос

## Дополнительные возможности

### Кастомизация обработки постов

Вы можете изменить логику обработки постов в файле `lib/telegram.ts`, функция `convertTelegramPostToBlogPost`.

### Изменение стиля блога

Стили блога находятся в компонентах:
- `app/blog/page.tsx` - список постов
- `app/blog/[slug]/page.tsx` - страница отдельного поста
