# Диагностика проблемы с восстановлением пароля

## Проблема
Домен `seohqs.com` верифицирован в Resend, но письма для восстановления пароля не приходят.

## Что было исправлено

1. **Улучшено логирование ошибок** - теперь все ошибки детально логируются в Vercel
2. **Улучшена обработка ошибок Resend API** - ошибки теперь правильно выбрасываются и логируются
3. **Добавлена детальная диагностика** - улучшен endpoint `/api/admin/email-diagnostics`

## Шаги для диагностики

### 1. Проверьте переменные окружения в Vercel

Убедитесь, что установлены следующие переменные:

```bash
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@seohqs.com  # или другой email на вашем домене
```

**ВАЖНО:** 
- `RESEND_FROM_EMAIL` должен быть в формате `something@seohqs.com`
- Домен `seohqs.com` должен быть верифицирован в Resend Dashboard

### 2. Проверьте диагностику

Откройте в браузере:
```
https://your-domain.com/api/admin/email-diagnostics
```

Это покажет:
- Какие переменные окружения установлены
- Какой метод отправки используется
- Рекомендации по настройке

### 3. Проверьте логи в Vercel

1. Откройте Vercel Dashboard
2. Перейдите в раздел "Logs"
3. Попробуйте запросить восстановление пароля
4. Проверьте логи на наличие ошибок

Теперь ошибки будут логироваться в формате:
```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "error": {
    "message": "...",
    "statusCode": 422,
    ...
  },
  "context": {
    "email": "...",
    ...
  },
  "environment": {
    "RESEND_API_KEY": "...",
    "RESEND_FROM_EMAIL": "...",
    ...
  }
}
```

### 4. Тестовая отправка email

Отправьте POST запрос на `/api/admin/email-diagnostics`:

```bash
curl -X POST https://your-domain.com/api/admin/email-diagnostics \
  -H "Content-Type: application/json" \
  -d '{"email": "your-test@email.com"}'
```

Это попытается отправить тестовое письмо и покажет детальные ошибки, если они есть.

### 5. Проверьте верификацию домена в Resend

1. Откройте [Resend Dashboard](https://resend.com/domains)
2. Найдите домен `seohqs.com`
3. Убедитесь, что статус показывает "Verified" (зеленая галочка)
4. Проверьте, что все DNS записи (SPF, DKIM, DMARC) настроены правильно

### 6. Возможные проблемы и решения

#### Проблема: Домен верифицирован, но письма не приходят

**Причины:**
1. `RESEND_FROM_EMAIL` не установлен или установлен неправильно
2. DNS записи не настроены правильно
3. Ошибка в Resend API (проверьте логи)

**Решение:**
1. Установите `RESEND_FROM_EMAIL=noreply@seohqs.com` в Vercel
2. Проверьте DNS записи в Resend Dashboard
3. Проверьте логи в Vercel на наличие ошибок

#### Проблема: Ошибка 422 или 403 при отправке

**Причина:** Домен не верифицирован или DNS записи не настроены

**Решение:**
1. Временно используйте `RESEND_FROM_EMAIL=onboarding@resend.dev` для тестирования
2. Верифицируйте домен в Resend Dashboard
3. После верификации верните `RESEND_FROM_EMAIL=noreply@seohqs.com`

#### Проблема: В логах Vercel ничего нет

**Причина:** Ошибки не логируются должным образом (исправлено в коде)

**Решение:**
1. Убедитесь, что используете последнюю версию кода
2. Проверьте логи в реальном времени в Vercel Dashboard
3. Используйте тестовую отправку для проверки

## Что делать дальше

1. **Проверьте логи в Vercel** после запроса восстановления пароля
2. **Используйте диагностический endpoint** для проверки настроек
3. **Проверьте верификацию домена** в Resend Dashboard
4. **Убедитесь, что `RESEND_FROM_EMAIL` установлен правильно**

Если проблема сохраняется, проверьте логи в Vercel - теперь они должны содержать детальную информацию об ошибках.
